name: Pipeline de Sécurité CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    name: Build et Tests Unitaires
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Configuration Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Installation des dépendances
        run: npm ci

      - name: Exécution des tests unitaires
        run: npm test

      - name: Upload du rapport de couverture
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/

  sast-semgrep:
    name: SAST - Semgrep
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Configuration Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Installation Semgrep
        run: pip3 install semgrep

      - name: Scan Semgrep avec règles personnalisées
        run: |
          semgrep --config=auto \
                   --config=p/owasp-top-ten \
                   --config=p/security-audit \
                   --config=p/nodejs \
                   --config=p/javascript \
                   --config=p/sql-injection \
                   --config=p/command-injection \
                   --config=p/xss \
                   --config=r/javascript.express.security \
                   --config=r/javascript.lang.security \
                   --config=.semgrep/rules.yaml \
                   --json --output=semgrep-results.json \
                   src/ || true

      - name: Affichage résultats Semgrep
        run: |
          echo "Résultats détaillés du scan Semgrep:"
          semgrep --config=auto \
                   --config=p/owasp-top-ten \
                   --config=p/security-audit \
                   --config=p/nodejs \
                   --config=p/javascript \
                   --config=p/sql-injection \
                   --config=p/command-injection \
                   --config=p/xss \
                   --config=r/javascript.express.security \
                   --config=r/javascript.lang.security \
                   --config=.semgrep/rules.yaml \
                   src/ || true

      - name: Vérification vulnérabilités
        run: |
          ERRORS=$(jq '[.results[] | select(.extra.severity == "ERROR")] | length' semgrep-results.json)
          WARNINGS=$(jq '[.results[] | select(.extra.severity == "WARNING")] | length' semgrep-results.json)
          INFO=$(jq '[.results[] | select(.extra.severity == "INFO")] | length' semgrep-results.json)
          
          echo ""
          echo "=========================================="
          echo "SEMGREP SAST - Résultats:"
          echo "  Vulnérabilités CRITIQUES (ERROR): $ERRORS"
          echo "  Vulnérabilités HAUTE (WARNING): $WARNINGS"
          echo "  Vulnérabilités INFO: $INFO"
          echo "=========================================="
          echo ""
          
          if [ "$ERRORS" -gt 0 ]; then
            echo "ÉCHEC: Vulnérabilités critiques détectées!"
            echo ""
            echo "Détails des vulnérabilités critiques:"
            jq -r '.results[] | select(.extra.severity == "ERROR") | "[\(.extra.severity)] \(.check_id)\n  Message: \(.extra.message)\n  Fichier: \(.path) ligne \(.start.line)\n  Code: \(.extra.lines)\n"' semgrep-results.json
            exit 1
          fi
          
          if [ "$WARNINGS" -gt 0 ]; then
            echo "AVERTISSEMENT: Vulnérabilités haute sévérité détectées!"
            echo ""
            echo "Détails des vulnérabilités haute sévérité:"
            jq -r '.results[] | select(.extra.severity == "WARNING") | "[\(.extra.severity)] \(.check_id)\n  Message: \(.extra.message)\n  Fichier: \(.path) ligne \(.start.line)\n"' semgrep-results.json
            exit 1
          fi
          
          echo "Aucune vulnérabilité critique ou haute détectée"

      - name: Upload résultats SAST
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sast-semgrep-results
          path: semgrep-results.json

  sca-owasp-dependency-check:
    name: SCA - OWASP Dependency-Check
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Configuration Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Installation des dépendances
        run: npm ci

      - name: Scan OWASP Dependency-Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'secure-app'
          path: '.'
          format: 'ALL'
          args: >
            --enableRetired
            --enableExperimental
            --failOnCVSS 7
            --suppression suppression.xml

      - name: Analyse des résultats
        if: always()
        run: |
          if [ -f dependency-check-report.json ]; then
            CRITICAL=$(jq '[.dependencies[].vulnerabilities[]? | select(.severity == "CRITICAL")] | length' dependency-check-report.json 2>/dev/null || echo "0")
            HIGH=$(jq '[.dependencies[].vulnerabilities[]? | select(.severity == "HIGH")] | length' dependency-check-report.json 2>/dev/null || echo "0")
            MEDIUM=$(jq '[.dependencies[].vulnerabilities[]? | select(.severity == "MEDIUM")] | length' dependency-check-report.json 2>/dev/null || echo "0")
            
            echo ""
            echo "=========================================="
            echo "OWASP DEPENDENCY-CHECK SCA - Résultats:"
            echo "  Vulnérabilités CRITIQUES: $CRITICAL"
            echo "  Vulnérabilités HAUTE: $HIGH"
            echo "  Vulnérabilités MOYENNE: $MEDIUM"
            echo "=========================================="
            echo ""
            
            if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
              echo "ÉCHEC: Vulnérabilités critiques/haute dans les dépendances!"
              echo ""
              echo "Détails des vulnérabilités critiques et haute:"
              jq -r '.dependencies[] | select(.vulnerabilities) | .fileName as $file | .vulnerabilities[] | select(.severity == "CRITICAL" or .severity == "HIGH") | "[\(.severity)] \(.name)\n  Description: \(.description)\n  Fichier: \($file)\n  CVSS: \(.cvssv3.baseScore // .cvssv2.score // "N/A")\n"' dependency-check-report.json | head -100
              exit 1
            fi
            
            echo "Aucune vulnérabilité critique ou haute détectée"
          else
            echo "AVERTISSEMENT: Rapport Dependency-Check non trouvé"
          fi

      - name: Upload rapport HTML
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report-html
          path: dependency-check-report.html

      - name: Upload rapport JSON
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report-json
          path: dependency-check-report.json

      - name: Upload rapport XML
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report-xml
          path: dependency-check-report.xml