name: Pipeline de Sécurité CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    name: Build et Tests Unitaires
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Configuration Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Installation des dépendances
        run: npm ci

      - name: Exécution des tests unitaires
        run: npm test

      - name: Upload du rapport de couverture
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/

  sast-semgrep:
    name: SAST - Semgrep
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Configuration Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Installation Semgrep
        run: pip3 install semgrep

      - name: Scan Semgrep avec règles personnalisées
        run: |
          semgrep --config=auto \
                   --config=p/owasp-top-ten \
                   --config=p/security-audit \
                   --config=p/nodejs \
                   --config=p/javascript \
                   --config=p/sql-injection \
                   --config=p/command-injection \
                   --config=p/xss \
                   --config=r/javascript.express.security \
                   --config=r/javascript.lang.security \
                   --config=.semgrep/rules.yaml \
                   --json --output=semgrep-results.json \
                   src/ || true

      - name: Affichage résultats Semgrep
        run: |
          echo "Résultats détaillés du scan Semgrep:"
          semgrep --config=auto \
                   --config=p/owasp-top-ten \
                   --config=p/security-audit \
                   --config=p/nodejs \
                   --config=p/javascript \
                   --config=p/sql-injection \
                   --config=p/command-injection \
                   --config=p/xss \
                   --config=r/javascript.express.security \
                   --config=r/javascript.lang.security \
                   --config=.semgrep/rules.yaml \
                   src/ || true

      - name: Vérification vulnérabilités
        run: |
          ERRORS=$(jq '[.results[] | select(.extra.severity == "ERROR")] | length' semgrep-results.json)
          WARNINGS=$(jq '[.results[] | select(.extra.severity == "WARNING")] | length' semgrep-results.json)
          INFO=$(jq '[.results[] | select(.extra.severity == "INFO")] | length' semgrep-results.json)
          
          echo ""
          echo "=========================================="
          echo "SEMGREP SAST - Résultats:"
          echo "  Vulnérabilités CRITIQUES (ERROR): $ERRORS"
          echo "  Vulnérabilités HAUTE (WARNING): $WARNINGS"
          echo "  Vulnérabilités INFO: $INFO"
          echo "=========================================="
          echo ""
          
          if [ "$ERRORS" -gt 0 ]; then
            echo "ÉCHEC: Vulnérabilités critiques détectées!"
            echo ""
            echo "Détails des vulnérabilités critiques:"
            jq -r '.results[] | select(.extra.severity == "ERROR") | "[\(.extra.severity)] \(.check_id)\n  Message: \(.extra.message)\n  Fichier: \(.path) ligne \(.start.line)\n  Code: \(.extra.lines)\n"' semgrep-results.json
            exit 1
          fi
          
          if [ "$WARNINGS" -gt 0 ]; then
            echo "AVERTISSEMENT: Vulnérabilités haute sévérité détectées!"
            echo ""
            echo "Détails des vulnérabilités haute sévérité:"
            jq -r '.results[] | select(.extra.severity == "WARNING") | "[\(.extra.severity)] \(.check_id)\n  Message: \(.extra.message)\n  Fichier: \(.path) ligne \(.start.line)\n"' semgrep-results.json
            exit 1
          fi
          
          echo "Aucune vulnérabilité critique ou haute détectée"

      - name: Upload résultats SAST
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sast-semgrep-results
          path: semgrep-results.json

  sca-npm-audit:
    name: SCA - npm audit
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Configuration Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Installation des dépendances
        run: npm ci

      - name: Audit npm
        run: |
          npm audit --json > npm-audit.json || true
          npm audit || true

      - name: Analyse résultats
        run: |
          CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' npm-audit.json)
          HIGH=$(jq '.metadata.vulnerabilities.high // 0' npm-audit.json)
          
          echo ""
          echo "=========================================="
          echo "NPM AUDIT SCA - Résultats:"
          echo "  Vulnérabilités CRITIQUES: $CRITICAL"
          echo "  Vulnérabilités HAUTE: $HIGH"
          echo "=========================================="
          echo ""
          
          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
            echo "ÉCHEC: Vulnérabilités critiques dans les dépendances!"
            jq -r '.vulnerabilities | to_entries[] | select(.value.severity == "critical" or .value.severity == "high") | "[\(.value.severity | ascii_upcase)] \(.key)\n  \(.value.via[0].title // .value.via[0])\n"' npm-audit.json
            exit 1
          fi

      - name: Upload résultats
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sca-npm-audit-results
          path: npm-audit.json

  dast-owasp-zap:
    name: DAST - OWASP ZAP
    runs-on: ubuntu-latest
    needs: [sast-semgrep, sca-npm-audit]
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Configuration Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Installation et démarrage application
        run: |
          npm ci
          npm start &
          APP_PID=$!
          echo "APP_PID=$APP_PID" >> $GITHUB_ENV
          sleep 15

      - name: Vérification disponibilité
        run: curl -f http://localhost:3000 || exit 1

      - name: Scan OWASP ZAP
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: 'http://localhost:3000'
          fail_action: false

      - name: Arrêt application
        if: always()
        run: kill $APP_PID || true

      - name: Upload résultats DAST
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dast-results
          path: |
            report_html.html
            report_json.json